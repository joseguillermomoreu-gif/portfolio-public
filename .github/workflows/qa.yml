name: QA Pipeline

on:
  push:
    branches: [master, develop]
  pull_request:
    branches: [master, develop]

jobs:
  quality-assurance:
    name: Quality Assurance
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, xml, zip, curl, intl
          tools: composer:v2
          coverage: xdebug

      - name: ğŸ“¦ Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: âœ… Validate composer.json
        run: composer validate --strict

      - name: ğŸ§ª Run PHPUnit Tests
        run: |
          if [ -f vendor/bin/phpunit ]; then
            vendor/bin/phpunit --testdox
          else
            echo "âš ï¸  PHPUnit not installed yet (will be configured in issue #006)"
          fi

      - name: ğŸ” Run PHPStan Analysis
        run: |
          if [ -f vendor/bin/phpstan ]; then
            vendor/bin/phpstan analyse --no-progress
          else
            echo "âš ï¸  PHPStan not installed yet (will be configured in issue #006)"
          fi

      - name: ğŸ­ Run Playwright E2E Tests
        run: |
          if [ -f package.json ] && grep -q "@playwright/test" package.json; then
            npm ci
            npx playwright install --with-deps
            npx playwright test
          else
            echo "âš ï¸  Playwright not installed yet (will be configured in issue #007)"
          fi

      - name: âœ… QA Pipeline Success
        if: success()
        run: |
          echo "âœ… All quality checks passed!"
          echo "ğŸ“Š Code quality verified"

      - name: âŒ QA Pipeline Failed
        if: failure()
        run: |
          echo "âŒ Quality checks failed!"
          echo "Please review the logs above."
          exit 1
