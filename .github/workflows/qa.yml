name: Quality Assurance

on:
  push:
    branches: [master]

jobs:
  qa:
    name: Quality Assurance
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, xml, zip, curl, intl
          tools: composer:v2
          coverage: xdebug

      - name: ğŸ“¦ Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-composer-

      - name: ğŸ“¦ Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: âœ… Validate composer.json
        run: composer validate --strict

      - name: ğŸ§ª Run PHPUnit Tests
        run: vendor/bin/phpunit --testdox --colors=always

      - name: ğŸ” Run PHPStan Analysis (level 9)
        run: vendor/bin/phpstan analyse --no-progress --error-format=github

      - name: ğŸ¨ Check Code Style (PHP CS Fixer)
        run: vendor/bin/php-cs-fixer fix --dry-run --diff --config=.php-cs-fixer.php

      - name: ğŸ­ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install Node dependencies
        run: npm ci

      - name: ğŸ” Run ESLint (TypeScript/Playwright)
        run: npm run lint

      - name: ğŸ­ Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: ğŸ­ Run E2E Tests (Production)
        env:
          BASE_URL: https://josemoreupeso.es
        run: npx playwright test --grep-invert "Home - Hero Section|Home - Quick Intro Section|Home - Skills Section|CSS Styles - Visual Regression Baseline"

      - name: âœ… QA Passed
        run: |
          echo "âœ… Quality Assurance checks passed!"
          echo "Commit: ${{ github.sha }}"
